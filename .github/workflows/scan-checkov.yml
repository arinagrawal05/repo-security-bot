name: "Scan: Checkov"

on:
  workflow_call:

jobs:
  checkov:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Checkov
        run: pip install --upgrade pip checkov

      - name: Run Checkov
        continue-on-error: true
        run: |
          mkdir -p reports
          checkov -d . --quiet -o json > reports/checkov_results.json || true

          if [ ! -s reports/checkov_results.json ]; then
            echo "[]" > reports/checkov_results.json
          fi

      # ðŸ“ NEW STEP: Generate List-Based Report (No Tables)
      - name: Generate Pretty Markdown Report
        run: |
          echo "## ðŸ— Checkov IaC Security Report" > reports/checkov.md
          echo "" >> reports/checkov.md

          if [ "$(cat reports/checkov_results.json)" == "[]" ]; then
             echo "âœ… *No misconfigurations found.*" >> reports/checkov.md
             exit 0
          fi

          # Force input to array for consistent processing
          jq -s 'if .[0] | type == "array" then .[0] else . end' reports/checkov_results.json > reports/checkov_clean.json

          # Loop through scan types (Terraform, Docker, etc.)
          jq -c '.[]' reports/checkov_clean.json | while read item; do
            
            TYPE=$(echo "$item" | jq -r '.check_type')
            FAILED=$(echo "$item" | jq -r '.summary.failed')
            PASSED=$(echo "$item" | jq -r '.summary.passed')
            
            echo "### ðŸ›  $TYPE Scan" >> reports/checkov.md
            echo "- ðŸ”´ *FAILED:* $FAILED" >> reports/checkov.md
            echo "- ðŸŸ¢ *PASSED:* $PASSED" >> reports/checkov.md
            echo "" >> reports/checkov.md

            if [ "$FAILED" -gt 0 ]; then
              echo "#### âš  Issues Found" >> reports/checkov.md
              
              # â¬‡ CHANGED HERE: List output instead of Table â¬‡
              echo "$item" | jq -r '.results.failed_checks[] | "- ðŸ”´ *\(.check_id): \(.check_name)\n  - **Resource:* \(.resource)\n  - *File:* \(.file_path):\(.file_line_range[0])\n"' | head -n 20 >> reports/checkov.md
              
              echo "" >> reports/checkov.md
            fi
            
            echo "---" >> reports/checkov.md
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: reports/checkov.md
