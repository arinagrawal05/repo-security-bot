name: "ðŸ”’ Repo Security Bot â€“ Summary"

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:

  # ---------------------------------------------------
  # 1. Run each scanner as a reusable workflow
  # ---------------------------------------------------
  gitleaks:
    uses: ./.github/workflows/scan-gitleaks.yml

  snyk:
    uses: ./.github/workflows/scan-snyk.yml
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  checkov:
    uses: ./.github/workflows/scan-checkov.yml

  dockle:
    uses: ./.github/workflows/scan-dockle.yml

  bandit:
    uses: ./.github/workflows/scan-bandit.yml

  # ---------------------------------------------------
  # 2. Summary job â€” runs AFTER all scans finish
  # ---------------------------------------------------
  generate-summary:
    runs-on: ubuntu-latest
    needs:
      - gitleaks
      - snyk
      - checkov
      - dockle
      - bandit

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # DOWNLOAD ALL REPORTS
      # ---------------------------------------------------
      - name: Download Gitleaks report
        uses: actions/download-artifact@v4
        with:
          name: gitleaks-report

      - name: Download Snyk report
        uses: actions/download-artifact@v4
        with:
          name: snyk-report

      - name: Download Checkov report
        uses: actions/download-artifact@v4
        with:
          name: checkov-report

      - name: Download Dockle report
        uses: actions/download-artifact@v4
        with:
          name: dockle-report

      - name: Download Bandit report
        uses: actions/download-artifact@v4
        with:
          name: bandit-report

      - name: Create reports folder
        run: mkdir -p reports

      - name: Move reports
        run: |
          mv gitleaks.json reports/
          mv snyk.json reports/
          mv checkov_results.json reports/
          mv dockle.json reports/
          mv bandit.json reports/

      # ---------------------------------------------------
      # SUMMARY GENERATION (your existing script goes here)
      # ---------------------------------------------------
      - name: Generate summary
        run: |
          # your entire markdown generation block here (unchanged)

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: reports/security-summary.md
