name: "Scan: Dockle"

on:
  push:
  pull_request:
  workflow_call:

jobs:
  dockle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Dockerfile
        id: detect
        run: |
          if [ -f "Dockerfile" ]; then
            echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
          elif [ -f "Dockerfile.txt" ]; then
            echo "dockerfile=Dockerfile.txt" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        if: steps.detect.outputs.dockerfile != ''
        run: |
          docker build -t security-image:latest -f "${{ steps.detect.outputs.dockerfile }}" . || true

      - name: Create reports directory
        run: mkdir -p reports

      - name: Pull Dockle
        run: docker pull goodwithtech/dockle:latest || true

      - name: Run Dockle scan
        continue-on-error: true
        run: |
          if [ "${{ steps.detect.outputs.dockerfile }}" = "" ]; then
            echo '{"message":"No Dockerfile found, skipped Dockle scan."}' > reports/dockle.json
          else
            # JSON output
            docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -v "${{ github.workspace }}/reports":/reports \
              goodwithtech/dockle:latest \
              -f json -o /reports/dockle.json security-image:latest || true

            docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              goodwithtech/dockle:latest security-image:latest \
              > reports/dockle.txt || true
          fi

      ####################################################################
      # ðŸ’Ž BEAUTIFUL REPORT GENERATION (PRETTIFIED)
      ####################################################################
           - name: Generate Pretty Markdown Report
        run: |
          echo "## ðŸ›¡ï¸ Dockle Security Summary" > reports/dockle.md
          echo "" >> reports/dockle.md

          # Detect if JSON is valid array
          TYPE=$(jq -r 'type' reports/dockle.json)

          if [ "$TYPE" != "array" ]; then
            echo "### â„¹ï¸ Dockle did not produce issue list" >> reports/dockle.md
            echo "" >> reports/dockle.md
            echo "Raw Output:" >> reports/dockle.md
            echo '```json' >> reports/dockle.md
            cat reports/dockle.json >> reports/dockle.md
            echo '```' >> reports/dockle.md
            exit 0
          fi

          # Extract counts
          FATAL=$(jq '[.[] | select(.level=="FATAL")] | length' reports/dockle.json)
          WARN=$(jq '[.[] | select(.level=="WARN")] | length' reports/dockle.json)
          INFO=$(jq '[.[] | select(.level=="INFO")] | length' reports/dockle.json)

          echo "### ðŸ” Summary" >> reports/dockle.md
          echo "- ðŸ”´ **FATAL:** $FATAL" >> reports/dockle.md
          echo "- ðŸŸ¡ **WARN:** $WARN" >> reports/dockle.md
          echo "- ðŸŸ¢ **INFO:** $INFO" >> reports/dockle.md
          echo "" >> reports/dockle.md

          #############################
          echo "### ðŸ”´ FATAL Issues" >> reports/dockle.md
          echo "| Code | Message | File |" >> reports/dockle.md
          echo "|------|---------|------|" >> reports/dockle.md
          jq -r '.[] | select(.level=="FATAL") | "| \(.code) | \(.title) | \(.target) |"' reports/dockle.json >> reports/dockle.md
          echo "" >> reports/dockle.md

          echo "### ðŸŸ¡ WARN Issues" >> reports/dockle.md
          echo "| Code | Message | File |" >> reports/dockle.md
          echo "|------|---------|------|" >> reports/dockle.md
          jq -r '.[] | select(.level=="WARN") | "| \(.code) | \(.title) | \(.target) |"' reports/dockle.json >> reports/dockle.md
          echo "" >> reports/dockle.md

          echo "### ðŸŸ¢ INFO Issues" >> reports/dockle.md
          echo "| Code | Message | File |" >> reports/dockle.md
          echo "|------|---------|------|" >> reports/dockle.md
          jq -r '.[] | select(.level=="INFO") | "| \(.code) | \(.title) | \(.target) |"' reports/dockle.json >> reports/dockle.md
